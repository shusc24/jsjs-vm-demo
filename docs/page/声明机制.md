# 声明机制

## 声明变量的基本模式

- 通过stack来存放key 值 或者 value 值
- 通过OUT 指令输入当前的stack里来变量声明

## 声明基本变量

```ts

var a = 2;
a = 789;

```

> 第一段 var a = 2 解析

```txt

STR(09) 
"a" (00 61 00 00)
VAR(10)
NUM(07) 
2 (40 00 00 00 00 00 00 00)
STR(09)
"a" (00 61 00 00)
OUT(12)
POP(0a)

```

- var a = 2 流程解析
    - 解析字符串并推入 stack中
        - STR(09)-> "a" (00 61 00 00)
    - 在scope 中声明 最新stack 中命名的变量
        - VAR(10)
    - 解析数值并推入stack中
        - NUM(07)-> 2 (40 00 00 00 00 00 00 00)
    - 解析字符串并推入stack中
        - STR(09)-> "a" (00 61 00 00)
    - 保存stack 中的变量到scope 中通过 scope 中out 方法 OUT 需要两个传入值 一个key 一个 val
        - OUT(12)-> POP(0a)

> 第二**段** a = 789 解析

```txt

NUM(07)                      
789 (40 88 a8 00 00 00 00 00)
STR(09)
"a" (00 61 00 00)
OUT(12)
POP(0a)
RET(33)

```

- a = 789; 流程解析
    - 解析数字并推入stack中
        - NUM(07)-> 789 (40 88 a8 00 00 00 00 00 00)
    - 解析字符串并推入stack中
        - STR(09)-> "a" (00 61 00 00)
    - 保存stack 中的变量到scope 中通过 scope 中out 方法 OUT 需要两个传入值 一个key 一个 val
        - OUT(12)-> POP(0a) -> RET(33)

## 声明复合变量

### 普通声明对象

```ts

var a = {
    a: 1,
    b: 2
};

```

```txt

.main_1:
        //初始化赋值
        STR(09)
        "a" (00 61 00 00)
        VAR(10)
        OBJ(03)
        TOP(0d)
        //第一轮赋值 a = 1
        STR(09)
        "a" (00 61 00 00)
        NUM(07)
        1 (3f f0 00 00 00 00 00 00)
        SET(41)
        POP(0a)
        TOP(0d)
        //第二轮赋值 b = 2
        STR(09)
        "b" (00 62 00 00)
        NUM(07)
        2 (40 00 00 00 00 00 00 00)
        SET(41)
        POP(0a)
        //scope out a = {a:1,b:2}
        STR(09)
        "a" (00 61 00 00)
        OUT(12)
        POP(0a)
        RET(33)
```

- 机制说明

@startuml
初始化赋值 -> 第一轮赋值: a = 1
第一轮赋值 -> 第二轮赋值: b = 2
第二轮赋值 -> scope: out a = {a:1,b:2}
@enduml

### 普通声明数组

```ts
var a = [1, 2];
```

```txt

.main_1:
        //初始化赋值
        STR(09)
        "a" (00 61 00 00)
        VAR(10)
        ARR(04)
        TOP(0d)
        //第一轮赋值 [0] = 1
        NUM(07)
        0 (00 00 00 00 00 00 00 00)
        NUM(07)
        1 (3f f0 00 00 00 00 00 00)
        SET(41)
        POP(0a)
        TOP(0d)
        //第二轮赋值 [1] = 2
        NUM(07)
        1 (3f f0 00 00 00 00 00 00)
        NUM(07)
        2 (40 00 00 00 00 00 00 00)
        SET(41)
        POP(0a)
        //scope out a = [1,2]
        STR(09)
        "a" (00 61 00 00)
        OUT(12)
        POP(0a)
        RET(33)
```

@startuml
初始化赋值 -> 第一轮赋值: [0] = 1
第一轮赋值 -> 第二轮赋值: [1] = 2
第二轮赋值 -> scope: out a = [1,2]
@enduml

### 声明数组复合变量

```ts
var a = [1, {a: 1}]
```


```txt

.main_1:
        //初始化赋值
        STR(09)
        "a" (00 61 00 00)
        VAR(10)
        ARR(04)
        TOP(0d)
        //第一轮赋值 [0] = 1
        NUM(07)
        0 (00 00 00 00 00 00 00 00)
        NUM(07)
        1 (3f f0 00 00 00 00 00 00)
        SET(41)
        POP(0a)
        TOP(0d)
        //第二轮赋值 stack.push 1
        NUM(07)
        1 (3f f0 00 00 00 00 00 00)
        //第三轮赋值 {a: 1}
        OBJ(03)
        TOP(0d)
        STR(09)
        "a" (00 61 00 00)
        NUM(07)
        1 (3f f0 00 00 00 00 00 00)
        SET(41)                    
        POP(0a)
        //第四轮 赋值 {a: 1}                     
        SET(41)
        POP(0a)
        //赋值 stack a = [1, {a: 1}]
        STR(09)
        "a" (00 61 00 00)
        // STR: [ [ 1, { a: 1 } ], 'a' ]
        OUT(12)
        POP(0a)
        RET(33)
```
@startuml
初始化赋值 -> 第一轮赋值: [0] = 1
第一轮赋值 -> 第二轮赋值: stack.push(1)
第二轮赋值 -> 第三轮赋值: {a: 1}
第三轮赋值 -> 第四轮赋值: [1, {a: 1}]
第四轮赋值 -> stack: a = [1, {a: 1}]
@enduml
